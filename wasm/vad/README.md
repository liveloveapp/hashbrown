# VAD WASM Build

This is a standalone Docker-based build system to build hashbrown's Voice Activity Detection (VAD) WASM module from the WebRTC source code. This directory contains everything needed to build the WASM module without any external dependencies.

## Overview

This build system allows you to compile the WebRTC VAD library to WebAssembly without installing any dependencies on your host machine (except Docker).

## Directory Contents

- `build.sh` - Main build script
- `test.sh` - Test script to launch local HTTP server
- `promote.sh` - Script to promote builds to stable (../bin/vad/)
- `Dockerfile` - Docker build configuration
- `CMakeLists.txt` - CMake configuration for the WASM build
- `rtc_stubs.c` - Stub implementations for missing WebRTC functions
- `example.html` - Interactive web demo for testing the VAD
- `vad_wrapper.js` - JavaScript wrapper class for easy VAD usage
- `README.md` - This file

## Prerequisites

- Docker installed and running
- At least 2GB of free disk space for the Docker image

## Building

To build the VAD WASM module, simply run:

```bash
./build.sh
```

The build script will:

- Build a Docker image with Emscripten and all dependencies (no cache)
- Pull the latest Emscripten base image
- Clone the latest WebRTC repository (inside the container only)
- Compile the VAD library to WebAssembly
- Capture the WebRTC commit SHA and build date
- Output the build artifacts to `./output/`

**Note:** The build uses `--no-cache` to ensure it always fetches the latest WebRTC source code. This means each build will take longer but guarantees you're building against the most recent WebRTC version.

## Output Files

After a successful build, you'll find these files in the `output/` directory:

- `webrtc_vad.js` - JavaScript wrapper for the WASM module (generated by Emscripten)
- `webrtc_vad.wasm` - WebAssembly binary
- `vad_wrapper.js` - High-level JavaScript wrapper class with build information
- `build-info.json` - JSON file containing WebRTC commit SHA and build date
- `webrtc_commit_sha.txt` - Plain text file with the WebRTC commit SHA

## Promoting to Stable

After building and testing, you can promote the build to stable (the `../bin/vad/` directory) using:

```bash
./promote.sh
```

This will copy the build artifacts from `output/` to the stable `../bin/vad/` directory and provide git commit instructions. See the [main WASM README](../README.md) for more details.

## Build Information

The build process captures the WebRTC repository commit SHA and build date. This information is available in multiple ways:

### 1. From the JavaScript Wrapper

The `vad_wrapper.js` file includes embedded build information:

```javascript
// Get build information
const buildInfo = WebRTCVAD.getBuildInfo();
console.log('WebRTC Commit SHA:', buildInfo.webrtc_commit_sha);
console.log('Build Date:', buildInfo.build_date);
console.log('Wrapper Version:', buildInfo.version);
```

### 2. From the build-info.json file

```bash
cat output/build-info.json
```

This file contains:

```json
{
  "webrtc_commit_sha": "abc123...",
  "build_date": "2025-10-18T12:34:56Z"
}
```

### 3. From the commit SHA file

```bash
cat output/webrtc_commit_sha.txt
```

This information allows you to track exactly which version of the WebRTC library was used to build your WASM module, which is important for debugging and reproducibility.

## Testing

To test the built WASM module in a browser, run:

```bash
./test.sh
```

This will:

1. Verify that the build output files exist
2. Start a Python HTTP server on http://localhost:8000
3. Serve example.html which loads files directly from the output/ directory

http://localhost:8000/example.html

The example page provides:

- Interactive VAD testing with your microphone
- Different VAD mode selection (0-3)
- Real-time voice activity detection visualization
- Sample audio testing

Press `Ctrl+C` to stop the test server.

## How It Works

The Dockerfile:

1. Uses the official Emscripten SDK Docker image
2. Clones the WebRTC repository at build time
3. Copies in the custom CMakeLists.txt and source files
4. Runs the Emscripten build process
5. Extracts only the compiled WASM files

This approach ensures that:

- No WebRTC source code is downloaded to your host machine
- No build dependencies are required on your host
- The build is reproducible and isolated
- Only the final artifacts are exported

## Troubleshooting

### Docker not running

If you see "Docker is not running", start Docker Desktop and try again.

### Build fails

- Ensure you have a stable internet connection (to clone WebRTC)
- Check that you have at least 2GB of free disk space
- Try removing any cached Docker images: `docker image rm webrtc-vad-builder`

### Output directory empty

Check the Docker container logs for build errors. The build process may have failed during compilation.

## Cleaning Up

To remove the Docker image and free up disk space:

```bash
docker image rm webrtc-vad-builder
docker image prune
```

To clean the output directory:

```bash
rm -rf output/
```
