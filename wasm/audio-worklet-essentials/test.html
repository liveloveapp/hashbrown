<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Audio Worklet Test</title>
  </head>
  <body>
    <button onclick="start()">Start</button>
    <div id="out"></div>
    <script type="module">
      let M;
      window.logIntegerFromWorklet = (v) => {
        document.getElementById('out').textContent = v;
        console.log('Received:', v);
      };
      const orig = AudioWorklet.prototype.addModule;
      AudioWorklet.prototype.addModule = function (u) {
        return orig.call(
          this,
          u.endsWith('.aw.js') || u.endsWith('.ww.js')
            ? new URL('./output/' + u, location).href
            : u,
        );
      };
      try {
        M = await (
          await import('./output/audio_worklet_essentials.js')
        ).default({
          locateFile: (p, pre) =>
            p.match(/\.(wasm|aw\.js|ww\.js)$/) ? './output/' + p : pre + p,
          mainScriptUrlOrBlob: new URL(
            './output/audio_worklet_essentials.js',
            location,
          ).href,
          onRuntimeInitialized: () => console.log('Module ready'),
        });
        window.start = () => {
          console.log('Starting...');
          M._main();
          setTimeout(() => {
            M.cwrap('ResumeAudioContext', null, [])();
            console.log('Resumed');
          }, 500);
        };
      } catch (e) {
        console.error('Load error:', e);
      }
    </script>
  </body>
</html>
