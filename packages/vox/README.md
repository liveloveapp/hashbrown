# @hashbrownai/vox

Voice Activity Detection (VAD) Audio Worklet with bundled WASM assets.

## Building

```bash
# Build the library
nx build vox
# Generate the embedded single-file loader (required)
node packages/vox/scripts/embed-singlefile.mjs
```

## Usage

```typescript
import { createVAD } from '@hashbrownai/vox';
import createModule from '@hashbrownai/vox/loader';

const vad = createVAD({
  mode: 2,
  onDecision: (d) => console.log(d === 1 ? 'VOICE' : 'NO VOICE'),
  // basePath is optional; defaults to the packaged assets
});

await vad.initialize(createModule);
await vad.start();
```

### Custom asset path

If you need to host the assets yourself, pass a `basePath` so the loader can find the files:

```typescript
const vad = createVAD({
  basePath: '/assets/vox/', // where vad_audio_worklet.* are served
});
```

## Serving requirements (WASM + AudioWorklet)

Any server (dev or production) that serves the VAD assets must:

- Serve `.wasm` with `Content-Type: application/wasm`.
- Enable cross-origin isolation for threads/SharedArrayBuffer by sending these headers on HTML and asset responses:
  - `Cross-Origin-Opener-Policy: same-origin`
  - `Cross-Origin-Embedder-Policy: require-corp`
- If hosting assets from a different origin, also add `Cross-Origin-Resource-Policy: cross-origin` on the asset responses.

Example (nginx):

```
types { application/wasm wasm; }

add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Resource-Policy "cross-origin" always;

location /assets/vox/ {
  root /var/www/yourapp/dist/packages/vox/;  # adjust to your deploy path
  try_files $uri =404;
}
```

## Distribution layout

- `index.mjs` / `index.cjs` / `index.d.ts` (entry points)
- `assets/vad_audio_worklet.single.js` (embedded WASM + worklet code, generated by the embed script)
- Export map includes `.`, `./loader`, `./loader-single`, and `./package.json` (both loader entries point to the embedded loader).

## Key lessons (build, assets, servers) for future maintainers

These notes summarize everything needed to make the package build, ship assets, and load correctly in browsers.

### Package/build shape
- `package.json`:
  - `sideEffects: false`
  - Entrypoints: `main` → `index.cjs`, `module` → `index.mjs`, `types` → `index.d.ts`
  - Export map includes:
    - `.` → `index.{cjs,mjs,d.ts}`
    - `./loader` → `assets/vad_audio_worklet.single.js`
    - `./loader-single` → `assets/vad_audio_worklet.single.js`
    - `./package.json`
  - `files`: `README.md`, `LICENSE`, `package.json`, `index.*`, `assets/**/*`
- Rollup (Nx):
  - Emits `index.{cjs,mjs}` + types and copies `packages/vox/src/assets/**/*` to `dist/packages/vox/assets/`.
  - `tsconfig` uses `module: esnext` so rollup can emit both CJS/ESM.
  - Asset sources live in `packages/vox/src/assets/`; the embedded loader is generated postbuild from `wasm/bin/vad-audio-worklet`.

### Runtime asset resolution
- Default runtime uses the embedded single-file loader (`vad_audio_worklet.single.js`) generated by the embed script; no separate WASM/worker fetches.
- `basePath` remains available if you need to host the embedded loader elsewhere (CDN/custom public path).
- Ensure the dev/prod server serves the embedded loader file; COOP/COEP headers are still required for AudioWorklet.

### Server requirements (dev and prod)
- COOP/COEP required for AudioWorklet + threads/SharedArrayBuffer:
  - `Cross-Origin-Opener-Policy: same-origin`
  - `Cross-Origin-Embedder-Policy: require-corp`
  - If hosting from a different origin, add `Cross-Origin-Resource-Policy: cross-origin` on the embedded loader responses.
- Serve the embedded loader with `Content-Type: application/javascript`.

Example (nginx):
```
types { application/wasm wasm; }

add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Resource-Policy "cross-origin" always;

location /assets/vox/ {
  root /var/www/yourapp/dist/packages/vox/;  # adjust to your deploy path
  try_files $uri =404;
}
```
